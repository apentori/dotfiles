#!/usr/bin/env python
import click
import requests
import time
import json
from typing import Dict, Any

DEFAULT_MODEL="deepseek-r1:32b"

# Timeout for the request
REQUEST_TIMEOUT = 30


@click.command()
@click.option(
    "--server",
    default="localhost",
    help="Remote server IP or hostname where Ollama is running (e.g., 192.168.1.100 or ollama.example.com)",
)
@click.option(
    "--port",
    default=11434,
    help="Port on which Ollama API is exposed (default: 11434)",
)
@click.option(
    "--model",
    default=DEFAULT_MODEL,
    help=f"Model name to use (default: {DEFAULT_MODEL})",
)
@click.option("-p", "--prompt",
    required=True,
    prompt="Enter a prompt",
    help="The prompt to send to Ollama",
)
@click.option(
    "--timeout",
    default=30,
    help="Request timeout in seconds (default: 30)",
)
def main(server: str, port: int, model: str, prompt: str, timeout: int):
    """
    Call Ollama on a remote server and return the response, token count, and time taken.
    """
    # Construct the full URL
    url="http://localhost:11434/api/generate"

    # Payload for the Ollama API
    payload = {
        "model": model,
        "prompt": prompt,
        "stream": False,  # We want the full response in one go
    }

    click.echo(f"Sending request to {server}:{port} using model '{model}'...")
    click.echo(f"Prompt: {prompt}")

    start_time = time.time()

    try:
        response = requests.post("http://localhost:11434/api/generate", json=payload, timeout=timeout)
        response.raise_for_status()
    except requests.exceptions.RequestException as e:
        click.echo(f"❌ Request failed: {e}", err=True)
        exit(1)

    end_time = time.time()
    elapsed_time = end_time - start_time

    # Parse the JSON response
    try:
        result: Dict[str, Any] = response.json()
    except json.JSONDecodeError:
        click.echo("❌ Invalid JSON response from Ollama server.", err=True)
        exit(1)

    # Extract the response and tokens
    reply = result.get("response", "").strip()
    tokens = result.get("eval_count", 0)  # Number of tokens evaluated

    # Output results
    click.echo("="*60)
    click.echo("✅ Success!")
    click.echo(f"Reply: {reply}")
    click.echo(f"Tokens used: {tokens}")
    click.echo(f"Time taken: {elapsed_time:.2f} seconds")
    click.echo("="*60)


if __name__ == "__main__":
    main()
